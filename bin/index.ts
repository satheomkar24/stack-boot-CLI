#!/usr/bin/env node
import { program } from "commander";

import { normalizeConfig } from "../src/normalizeConfig.js";
import { parseArgs } from "../src/parseArgs.js";
import { runPrompts } from "../src/promptFlow.js";
import { runCreateCommand } from "../src/runCreateCommand.js";
import { log } from "../src/utils/logger.js";
import { checkNodeVersion } from "../src/utils/checkNodeVersion.js";
import { getCliVersion } from "../src/utils/getCliVersion.js";
import { checkForUpdate } from "../src/utils/checkForUpdate.js";

process.on("SIGINT", () => {
  log.info("\nðŸ›‘ CLI process cancelled by user.");
  process.exit(130);
});

// environment checks (non-blocking)
const version = getCliVersion();

const skipUpdateCheck =
  process.argv.includes("-v") ||
  process.argv.includes("--version") ||
  process.argv.includes("--help");

if (!skipUpdateCheck) {
  checkNodeVersion();
  checkForUpdate(version);
}

program
  .name("stackboot")
  .description("CLI to create projects from predefined templates")
  .version(version, "-v, --version", "Show CLI version");

program
  .command("create")
  .argument("[stackVersion]", "Stack and version (e.g., react@18, node)")
  .argument("[projectName]", "Name of the new project")
  .argument(
    "[variant]",
    "React/Node: Variant (e.g., base, auth, admin) / Java: Group Id",
  )
  .helpOption("-h, --help", "Display help for command")
  .action(async (stackVersion, projectName, variant) => {
    try {
      const parsed = parseArgs([stackVersion, projectName, variant]);

      let config;
      if (parsed.isComplete) {
        if (!parsed.stack || !parsed.projectName) {
          throw new Error("Required arguments missing: stack or project name");
        }

        config = normalizeConfig(
          {
            stack: parsed.stack,
            version: parsed.version,
            variant: parsed.variant,
            projectName: parsed.projectName,
            groupId: parsed.groupId,
          },
          "args",
        );
      } else {
        const prompted = await runPrompts(parsed);
        config = normalizeConfig(prompted, "interactive");
      }

      await runCreateCommand(config);
      console.log(
        "âœ¨ Generated by Stack Boot CLI\n\nðŸ“˜ Documentation: https://stackbootcli.netlify.app\n",
      );
    } catch (error: any) {
      log.error(error?.message || "Failed to create project.");
    }
  });

program.parse(process.argv);
